# TableCat 设计文档
更新日期：2026-02-28

## 1. 产品目标
TableCat 是一个运行在 Windows + Electron 上的桌面宠物应用。它持续观察用户当前的电脑使用状态，在合适的时候以角色化气泡回复的形式进行陪伴式互动。

产品目标不是“任何感知都立刻说话”，而是：
- 高频、低成本地观察用户状态
- 低频、有价值地触发 AI 回复
- 保持角色卡驱动的人设一致性
- 为调试和回溯提供足够的可观测性

## 2. 当前能力范围
当前实现包含以下能力：
- 桌面宠物面板、气泡、历史记录、交互聊天窗
- 角色卡加载与记忆写回
- 启动首次问候
- 屏幕感知门控链路
- 多图送模
- API 连通性测试
- 调试评分面板
- 启动级日志与门控调试落盘

## 3. 感知设计
### 3.1 多通道感知
系统保留三类感知入口：
- `screen`
- `mic`
- `system_audio`

其中当前重点实现和调优的是 `screen`。`mic` 与 `system_audio` 仍保留旧的定时轮询框架。

### 3.2 两层时间尺度
当前设计明确区分两种频率：
- 检测间隔：多久观察一次状态
- AI 提交间隔：多久允许真正发一次模型请求

这两者不是同一个概念。

当前默认值：
- 屏幕门控检测间隔 `screen_gate_tick_ms = 500`
- 屏幕触发最短 AI 提交间隔 `screen_global_cooldown_sec = 1`
- 通用旧轮询 `perception_interval_sec = 5`

约束范围：
- `screen_gate_tick_ms` 最低 `100ms`
- `screen_global_cooldown_sec` 最低 `1s`
- `perception_interval_sec` 最低 `1s`

### 3.3 屏幕门控目标
屏幕感知不再采用“每轮截图直接送 AI”的直通模式，而是先做门控判断：
- 只在值得开口时触发
- 先算分，再决定是否送模
- 在当前回复还在显示时，允许更高分事件抢占旧回复

## 4. 回复设计
### 4.1 回复形式
回复以结构化 JSON 为主，界面上只展示 `content`。

界面层当前包含：
- 宠物气泡
- 回复历史
- 双击打开的交互聊天面板

### 4.2 抢占式回复
当前新增了“高分事件抢占”设计：
- 如果当前气泡仍在显示，且新的屏幕事件分数更高，则允许打断旧回复
- 如果旧请求还在进行中，新事件会进入待处理队列
- 当旧请求返回时，如果它已经落后于新的更高分事件，则旧结果不再上屏

这使得桌宠更容易围绕真正的高光时刻回应，而不是被较低价值的旧事件占住气泡窗口。

## 5. 角色与 Prompt 设计
角色人格仍由角色卡决定，基础 Prompt 已抽离到 `prompts.csv`，可直接调试。

当前 Prompt 设计原则：
- 默认优先简体中文
- 截图类输入优先基于可见内容回答
- 看不清时明确说明，不鼓励过度脑补
- 多图输入时优先关注 ROI 与变化内容

## 6. 调试与可观测性
### 6.1 实时评分调试
宠物面板上提供实时评分牌，展示：
- `finalScore / excitement / interrupt / novelty`
- `L0 / L1` 是否通过
- 当前检测间隔
- 当前采样模式
- 当前冷却剩余时间
- 前台进程信息
- 当前回复分数与阶段

### 6.2 日志与落盘
当前支持三类调试落盘：
- 全局运行日志：`LOG/app.log`
- 本次启动日志：`LOG/sessions/<session>.log`
- 当前 session 指针：`LOG/latest-session.txt`

屏幕感知相关目录：
- 截图目录：`LOG/screenshots/<session>/`
- 门控目录：`LOG/screen-attention/<session>/`

门控目录中包含：
- `frames/`
- `roi/`
- `events/`
- `llm/`
- `metrics/summary.json`

## 7. 设置设计
当前设置区已映射以下关键能力：
- 总体感知开关
- 旧轮询间隔
- 截图门控开关
- 屏幕检测间隔
- 活跃时临时升频开关
- 屏幕触发阈值
- AI 最短提交间隔
- 是否保存门控帧
- 主动陪伴开关与间隔
- 打开截图目录 / 打开门控目录 / API 测试

## 8. 当前产品边界
当前仍有明确边界：
- `mic` 与 `system_audio` 尚未接入同等级别门控
- 回复打断是“结果抢占/队列抢占”，不是流式中断模型输出
- 主动陪伴默认关闭
- 多图送模已经接通，但仍需继续做阈值和体验调参

## 9. 相关文档
- 总体技术设计：`docs/tech/tech-design.md`
- 多级门控专项：`docs/tech/multilevel-gating.md`
- 触发机制专项：`docs/tech/trigger-mechanism.md`
