# 技术设计方案

本文件基于 `docs/design.md` 与用户确认的体验侧要求，整理可实现的技术方案与约束。

## 目标与范围
- 桌面宠物在前台展示，具备感知、记忆、回复与设置能力。
- 感知包括桌面截图、麦克风输入、系统/桌面音频语音识别。
- 角色扮演由角色卡驱动，回复可气泡显示与语音播报。
- 多路感知分流送入大模型，不做前端可视化区分。

## 关键体验约束（已确认）
- 感知间隔默认 5s，最大 30s，可配置。
- 感知默认全开，但可在设置中勾选单路开关。
- 热词唤醒暂不实现（TODO），默认常开麦克风。
- 麦克风接收提示：宠物头顶冒气泡表示正在接收；静音 1s 后自动关闭提示。
- 多路感知不做 UI 分流，仅在模型输入中标注来源。
- 感知周期提示使用转圈指示。
- 气泡仅展示回复文本；气泡与交互窗口互不影响。
- 语气/风格由角色 prompt 决定。
- 永远前端不做特殊处理。
- Setting 入口需要可发现性提示。
- 角色卡最小字段规范可自行设计。
- 角色卡首次引导暂不做。
- 语音回复默认开启，支持“仅文本不朗读”选项。
- 回复打断与热词唤醒一起做（TODO）。
- 启动后自动向 AI 请求首次问候。
- 回复为结构化格式：推理内容、情绪、回复内容。
- 角色卡支持宠物图标路径，未配置时仅显示面板。
- Live2D 接入为 TODO。
- 传给 AI 需要默认角色扮演提示词：正常交流、吐槽般简短，除非要求详细解释；第一人称回复。
- AI 回复增加记忆总结，软件将记忆写入角色卡记忆区。

## 系统结构
### 模块划分
- 感知调度器：周期性触发感知采集与聚合输入。
- 感知采集器
  - 截图采集
  - 麦克风采集 + 语音识别
  - 系统/桌面音频采集 + 语音识别
- 输入整形器：对不同来源数据打标签并构建模型输入。
- 记忆模块：将互动转为结构化记忆；向模型请求时不包含上下文。
- 回复渲染器：气泡 UI + 可选 TTS 播报。
- 启动问候器：应用启动后触发首次问候请求。
- 设置中心：感知开关、感知间隔、缩放、API、角色卡管理。
- 角色卡管理：读取本地 JSON，校验最小字段并提供 prompt。

## 感知与调度
### 感知间隔
- 默认值：5s
- 最大值：30s
- 可配置：Settings 中提供滑块或输入框，范围 [5, 30]。

### 感知流程
1. 调度器按间隔触发感知采集。
2. 每路感知独立采集并标注来源。
3. 到达间隔结束，将三路数据打包送入模型。
4. 不做前端分流展示，仅模型输入注明来源。

### 提示与状态
- 感知周期进行时显示转圈提示。
- 麦克风监听提示：宠物头顶出现“正在接收”气泡。
- 语音输入静默 1s 后自动关闭提示。

## 输入格式与分流标注
模型输入需包含来源标签，避免合流。
示例（非最终格式）：
```
[source:screen] <截图文本/摘要>
[source:mic] <麦克风转写>
[source:system_audio] <系统音频转写>
```
### 默认角色扮演提示词
```
你是桌面宠物角色，请以第一人称进行角色扮演回复。
风格为正常交流、吐槽般简短，除非用户明确要求详细解释。
请只输出 JSON，不要包含额外文本，字段如下：
{
  "reasoning": "string",
  "emotion": "string",
  "content": "string",
  "memory_summary": "string"
}
```

## 角色卡设计
### 最小字段规范（建议）
- name: 角色名称
- prompt: 角色设定与语气风格
- api: 可选，覆盖全局配置
- scale: 可选，覆盖全局缩放
- wake_word: 可选，热词唤醒用称谓（TODO）
- pet_icon_path: 可选，宠物图标路径（本地图片）
- memory: 可选，记忆列表（字符串数组）

### 校验规则
- JSON 格式合法。
- 必须包含 name 与 prompt。
- 可选字段若存在需类型正确。

## 回复与表现
- 回复为结构化格式，解析后展示与播报，并提取记忆总结。
- 气泡仅展示回复内容，无额外状态设计。
- 气泡自动消失时间可配置，默认 3s，新回复刷新计时。
- 提供回复历史面板，展示所有回复内容。
- 气泡与交互窗口互不影响。
- 语音回复默认开启，可切换“仅文本不朗读”，TTS 输入为回复内容字段。
- 打断与热词唤醒联动为 TODO。

## 界面交互
- 窗口支持拖动移动，设置按钮与历史按钮不参与拖动区域。
### 语音模型接入（TTS）
- 接入 OpenAI TTS 接口，将 `content` 字段转语音。
- 默认模型与音色在设置中配置（例如 `gpt-4o-mini-tts` + `alloy`）。
- 播放与气泡同时触发，若关闭语音则仅气泡输出。
### 记忆写入
- 收到 `memory_summary` 后将其追加到角色卡 `memory`。
- 角色卡文件需要持久化保存。
### 启动首次问候
- 应用启动完成后触发首次问候请求。
- 首次问候走与普通回复一致的结构化格式解析与呈现。

## 设置项清单
- 感知间隔（5s-30s）
- 感知开关：截图 / 麦克风 / 系统音频
- 角色卡选择与导入
- API 配置
- 缩放
- 语音播报开关
- 气泡自动消失时间（默认 3s）

## TODO 清单
- 热词唤醒（包括唤醒提示与打断回复）
- 回复打断逻辑
- Live2D 接入

## 数据结构体（建议）
### RoleCard
```
{
  "name": "string",
  "prompt": "string",
  "api": "string?",
  "scale": "number?",
  "wake_word": "string?",
  "pet_icon_path": "string?"
}
```

### PerceptionInput
```
{
  "source": "screen|mic|system_audio",
  "content": "string"
}
```

### ModelRequest
```
{
  "inputs": "PerceptionInput[]",
  "memory": "string?",
  "role_prompt": "string",
  "default_prompt": "string"
}
```

### ModelResponse
```
{
  "reasoning": "string",
  "emotion": "string",
  "content": "string",
  "memory_summary": "string"
}
```

### MemoryWriteback
```
{
  "role_card_path": "string",
  "memory_summary": "string"
}
```

### AppSettings
```
{
  "perception_interval_sec": "number",
  "enable_screen": "boolean",
  "enable_mic": "boolean",
  "enable_system_audio": "boolean",
  "api_key": "string?",
  "scale": "number?",
  "tts_enabled": "boolean",
  "bubble_timeout_sec": "number?"
}
```

## 实现顺序建议
1. 完成感知调度与分流输入格式。
2. 完成气泡与转圈提示 UI。
3. 角色卡读取与最小字段校验。
4. 设置中心（感知开关、间隔、语音开关）。
5. 接入 TTS 播报开关。
6. 启动首次问候流程与结构化回复解析。
